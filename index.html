<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIVM Control Center | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --text-main: #c9d1d9;
            --accent: #58a6ff;
            --accent-hover: #1f6feb;
            --border: #30363d;
            --locked: #8b949e;
            --success: #2ea043;
            --danger: #da3633;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styling */
        #sidebar {
            width: 250px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #sidebar h2 {
            font-size: 1.2rem;
            color: var(--text-main);
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-item:hover {
            background-color: rgba(88, 166, 255, 0.1);
        }

        .nav-item.locked {
            color: var(--locked);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .nav-item.locked:hover {
            background-color: transparent;
        }

        .badge {
            font-size: 0.7rem;
            background: var(--border);
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Main Content Styling */
        #main-content {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 40px;
        }

        button {
            background-color: var(--panel-bg);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        button.primary {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }

        button.primary:hover {
            background-color: #3fb950;
        }

        .view-section {
            display: none; /* Hidden by default */
            background-color: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            margin-bottom: 20px;
        }

        .view-section.active {
            display: block;
        }

        input {
            background-color: var(--bg-color);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 6px;
            width: calc(100% - 26px);
            margin-bottom: 15px;
        }

        /* Toast Notifications */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Lightchain AIVM</h2>
        <div id="nav-generator" class="nav-item locked" onclick="handleNavClick('generator')">
            <span>LCAI Generator</span>
            <span class="lock-icon">ðŸ”’</span>
        </div>
        <div id="nav-market" class="nav-item locked" onclick="handleNavClick('market')">
            <span>Marketplace</span>
            <div>
                <span class="badge">WIP</span>
                <span class="lock-icon">ðŸ”’</span>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <button id="btn-connect" onclick="connectWallet()">Connect Wallet</button>
        </div>

        <div id="view-disconnected" class="view-section active">
            <h3>System Offline</h3>
            <p>Please connect your wallet to access the Lightchain AI Testnet.</p>
        </div>

        <div id="view-register" class="view-section">
            <h3>Identity Required</h3>
            <p>Your address is not registered on the Lightchain Identity network.</p>
            <button class="primary" onclick="registerIdentity()">Register On-Chain Identity</button>
        </div>

        <div id="view-verify" class="view-section">
            <h3>Awaiting ZK Verification</h3>
            <p>You are registered! Please wait for a network admin to confirm your ZK-proof verification.</p>
            <button onclick="checkIdentityState()">Refresh Status</button>
        </div>

        <div id="view-mint" class="view-section">
            <h3>Verification Confirmed</h3>
            <p>Your identity is verified. Mint your Soulbound Token (SBT) to unlock network features.</p>
            <button class="primary" onclick="mintSBT()">Mint ZK-Pass SBT</button>
        </div>

        <div id="view-success" class="view-section">
            <h3 style="color: var(--success);">System Online</h3>
            <p>You hold a valid ZK-Pass SBT. All primary systems are unlocked via the menu on the left.</p>
        </div>

        <div id="view-admin" class="view-section" style="border-color: var(--accent);">
            <h3>Admin Management</h3>
            <input type="text" id="target-address" placeholder="Enter 0x address...">
            <div style="display: flex; gap: 10px;">
                <button onclick="adminQuery()">Query Status</button>
                <button class="primary" onclick="adminVerify()">Verify Identity</button>
                <button style="background: var(--danger); border-color: var(--danger);" onclick="adminRevoke()">Revoke</button>
            </div>
        </div>

        <div id="view-owner" class="view-section" style="border-color: #d2a8ff;">
            <h3>Owner Vault</h3>
            <p>Accumulated Revenue: <span id="revenue-display">0.00</span> LCAI</p>
            <button onclick="withdrawFunds()">Withdraw Funds</button>
        </div>

    </div>

    <div id="toast">Message</div>

    <script>
        // ==========================================
        // CONFIGURATION (Update these with your Remix deployments)
        // ==========================================
        const IDENTITY_CONTRACT_ADDRESS = "0x8300C9072Bc9F926703f8E26Ff0a5D963d88Ae01"; 
        const SBT_CONTRACT_ADDRESS = "0xd71462F0002Ee9373fCe05B568583Ed13e75f600";
        
        // Minimal ABIs required for the flow
        const identityABI = [
            "function isVerified(address _user) view returns (bool)",
            "function registerIdentity() external",
            "function verifyIdentity(address _user) external",
            "function revokeIdentity(address _user) external",
            "function owner() view returns (address)",
            "function isAdmin(address _user) view returns (bool)"
        ];

        const sbtABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function mintIdentity() external"
        ];

        let provider, signer, userAddress;
        let identityContract, sbtContract;

        // ==========================================
        // INITIALIZATION & STATE MANAGEMENT
        // ==========================================
        async function connectWallet() {
            if (!window.ethereum) {
                showToast("Please install a Web3 wallet like MetaMask.");
                return;
            }
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('btn-connect').innerText = `Connected: ${userAddress.substring(0,6)}...${userAddress.slice(-4)}`;
                
                // Init Contracts
                identityContract = new ethers.Contract(IDENTITY_CONTRACT_ADDRESS, identityABI, signer);
                sbtContract = new ethers.Contract(SBT_CONTRACT_ADDRESS, sbtABI, signer);

                await checkIdentityState();
                await checkAdminRoles();
            } catch (error) {
                console.error("Connection error:", error);
            }
        }

        async function checkIdentityState() {
            if (!userAddress) return;

            try {
                // Determine Registration/Verification
                // *Note: Adjust this logic if your contract handles 'isRegistered' differently.
                // Here we assume if 'isVerified' throws or fails, they aren't registered.
                let verified = false;
                try {
                    verified = await identityContract.isVerified(userAddress);
                } catch (e) {
                    // Contract might throw if identity doesn't exist
                    switchView('view-register');
                    return;
                }

                if (!verified) {
                    // We assume they are registered but not verified yet if it didn't throw
                    switchView('view-verify');
                    return;
                }

                // If Verified, check SBT Balance
                const sbtBalance = await sbtContract.balanceOf(userAddress);
                if (sbtBalance.toNumber() === 0) {
                    switchView('view-mint');
                } else {
                    switchView('view-success');
                    unlockMenu();
                }

            } catch (error) {
                console.error("State check failed:", error);
                switchView('view-register'); // Fallback to state 1
            }
        }

        async function checkAdminRoles() {
            try {
                const isAdmin = await identityContract.isAdmin(userAddress);
                if (isAdmin) {
                    document.getElementById('view-admin').classList.add('active');
                }
                const owner = await identityContract.owner();
                if (userAddress.toLowerCase() === owner.toLowerCase()) {
                    document.getElementById('view-owner').classList.add('active');
                }
            } catch(e) { console.log("Role check failed or unsupported."); }
        }

        // ==========================================
        // USER ACTIONS
        // ==========================================
        async function registerIdentity() {
            try {
                const tx = await identityContract.registerIdentity();
                showToast("Transaction sent! Waiting for confirmation...");
                await tx.wait();
                showToast("Registration successful!");
                checkIdentityState();
            } catch (error) {
                showToast("Registration failed. See console.");
                console.error(error);
            }
        }

        async function mintSBT() {
            try {
                const tx = await sbtContract.mintIdentity();
                showToast("Minting SBT! Waiting for confirmation...");
                await tx.wait();
                showToast("SBT Minted Successfully!");
                checkIdentityState();
            } catch (error) {
                showToast("Minting failed. See console.");
                console.error(error);
            }
        }

        // ==========================================
        // ADMIN ACTIONS
        // ==========================================
        async function adminVerify() {
            const target = document.getElementById('target-address').value;
            if(!target) return showToast("Enter an address first.");
            try {
                const tx = await identityContract.verifyIdentity(target);
                await tx.wait();
                showToast(`Verified ${target}`);
            } catch(e) { console.error(e); showToast("Admin verify failed."); }
        }

        async function adminRevoke() {
            const target = document.getElementById('target-address').value;
            if(!target) return showToast("Enter an address first.");
            try {
                const tx = await identityContract.revokeIdentity(target);
                await tx.wait();
                showToast(`Revoked ${target}`);
            } catch(e) { console.error(e); showToast("Admin revoke failed."); }
        }

        // ==========================================
        // UI HELPERS
        // ==========================================
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // Re-add admin/owner panels if they apply
            checkAdminRoles(); 
        }

        function unlockMenu() {
            const items = document.querySelectorAll('.nav-item');
            items.forEach(item => {
                item.classList.remove('locked');
                const lockIcon = item.querySelector('.lock-icon');
                if (lockIcon) lockIcon.style.display = 'none';
            });
        }

        function handleNavClick(destination) {
            const el = document.getElementById(`nav-${destination}`);
            if (el.classList.contains('locked')) {
                showToast("Please complete your Identity setup to unlock this feature.");
                return;
            }
            // Add your routing/navigation logic here
            showToast(`Navigating to ${destination}...`);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 4000);
        }
    </script>
</body>
</html>
