<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI Identity Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #007bff; --admin: #dc3545; --bg: #f4f7f6; --text: #333; --success: #28a745; --mimo: #1877F2; --owner: #6f42c1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2, h3, h4 { margin-top: 0; color: #0056b3; }
        input[type="text"] { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-admin { background: var(--admin); color: white; }
        .btn-owner { background: var(--owner); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 900px; margin-bottom: 20px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .mimo-badge { background: var(--mimo); color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-left: 5px; }
        .result-window { background: #e9ecef; padding: 15px; border-radius: 4px; min-height: 50px; margin-top: 15px; border-left: 5px solid var(--primary); white-space: pre-wrap; font-family: monospace; }
        .log-container { max-height: 200px; overflow-y: auto; font-size: 0.8rem; background: #f8f9fa; padding: 10px; border-radius: 4px; }
        .tx-item { padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div>
            <strong>Status:</strong> <span id="walletStatus">Disconnected</span>
            <span id="userBadge"></span>
        </div>
        <div>
            <strong style="color:var(--success)" id="tokenBalance">0.0000</strong> LCAI
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="card">
                <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
                <button id="disconnectBtn" class="btn btn-secondary" style="display:none">Disconnect</button>
            </div>

            <div id="adminConsole" class="card" style="display:none">
                <h3>Identity Admin</h3>
                <input type="text" id="lookupAddr" placeholder="Lookup Address">
                <button id="lookupBtn" class="btn btn-primary">Query Status</button>
                <div id="lookupResults" style="margin-top:10px; font-size:0.9rem"></div>
                <hr>
                <input type="text" id="verifyAddr" placeholder="Target Address">
                <button id="verifyBtn" class="btn btn-success">Verify User</button>
                <button id="revokeBtn" class="btn btn-admin">Revoke User</button>
                <p id="adminFeedback" style="font-size:0.8rem; text-align:center"></p>
            </div>

            <div id="ownerConsole" class="card" style="display:none; border-top: 5px solid var(--owner);">
                <h3>Oracle Owner</h3>
                <p>Revenue: <strong id="totalRevenueDisplay">0</strong> LCAI</p>
                <button id="toggleFeesBtn" class="btn btn-owner">Toggle Fees</button>
                <button id="withdrawBtn" class="btn btn-success">Withdraw</button>
                <div class="log-container" id="revenueLog" style="margin-top:10px"></div>
            </div>
        </div>

        <div class="main">
            <div id="oracleUI" class="card" style="display:none">
                <h2>Visionary Oracle</h2>
                <input type="text" id="oracleQuestion" placeholder="Ask about the future...">
                <button id="shakeBtn" class="btn btn-success">Consult AIVM</button>
                <div id="resultText" class="result-window">The Oracle awaits your question...</div>
            </div>

            <div class="card">
                <h3>Global Activity</h3>
                <p>Total Predictions: <strong id="globalCount">0</strong></p>
                <div class="log-container" id="txFeed"></div>
            </div>
        </div>
    </div>

    <script>
        const IDENTITY_CONTRACT = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";
        const BALL_CONTRACT_ADDR = "0x051622e51Eca74c34FD26c43c3032fDf65bDFE2c"; 
        const SYSTEM_PROMPT = "As a forward-thinking innovator and futurist, provide a prediction for: ";

        const BALL_ABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"question","type":"string"},{"indexed":false,"internalType":"string","name":"answer","type":"string"}],"name":"OracleAnswer","type":"event"},{"inputs":[{"internalType":"string","name":"_question","type":"string"}],"name":"getPrediction","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"totalPredictions","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"_enabled","type":"bool"}],"name":"toggleFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"feesEnabled","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        const IDENTITY_ABI = [{"inputs":[{"internalType":"string","name":"_username","type":"string"},{"internalType":"string","name":"_did","type":"string"}],"name":"createIdentity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getIdentity","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isAdmin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"verifyIdentity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"revokeVerification","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        let signer, ballContract, identityContract;
        
        // Accurate Byte Length Calculation
        const getByteLength = (str) => new TextEncoder().encode(str).length;

        async function hardSync() {
            try {
                const address = await signer.getAddress();
                const [total, owner, isAdmin, profile, feesOn, contractBalance] = await Promise.all([
                    ballContract.totalPredictions(),
                    ballContract.admin(),
                    identityContract.isAdmin(address),
                    identityContract.getIdentity(address),
                    ballContract.feesEnabled(),
                    signer.provider.getBalance(BALL_CONTRACT_ADDR)
                ]);

                // Update UI
                document.getElementById('walletStatus').innerText = address.substring(0, 10) + "...";
                document.getElementById('globalCount').innerText = total.toString();
                document.getElementById('tokenBalance').innerText = parseFloat(ethers.formatEther(await signer.provider.getBalance(address))).toFixed(4);
                document.getElementById('totalRevenueDisplay').innerText = parseFloat(ethers.formatEther(contractBalance)).toFixed(3);

                document.getElementById('adminConsole').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('ownerConsole').style.display = (address.toLowerCase() === owner.toLowerCase()) ? 'block' : 'none';
                
                if (profile[2]) {
                    document.getElementById('oracleUI').style.display = 'block';
                    document.getElementById('userBadge').innerHTML = `<span class="mimo-badge" title="Verified MiMo Member">✓</span>`;
                }

                document.getElementById('toggleFeesBtn').innerText = `Fees: ${feesOn ? 'ON' : 'OFF'}`;
                updateFeeDisplay();
                syncLogs();
            } catch (e) { console.error(e); }
        }

        function updateFeeDisplay() {
            const q = document.getElementById('oracleQuestion').value;
            const fullPrompt = SYSTEM_PROMPT + q;
            ballContract.feesEnabled().then(on => {
                if (on && q) {
                    const bytes = getByteLength(fullPrompt);
                    const cost = ((Math.floor(bytes / 10) + 1) * 0.001).toFixed(3);
                    document.getElementById('shakeBtn').innerText = `Consult AIVM (${cost} LCAI)`;
                } else {
                    document.getElementById('shakeBtn').innerText = "Consult AIVM (Free)";
                }
            });
        }

        async function syncLogs() {
            const filter = ballContract.filters.OracleAnswer();
            const events = await ballContract.queryFilter(filter, -2000);
            const feed = document.getElementById('txFeed');
            const revenue = document.getElementById('revenueLog');
            feed.innerHTML = ''; revenue.innerHTML = '';

            events.reverse().forEach(ev => {
                const isSystem = ev.args.question.startsWith(SYSTEM_PROMPT);
                const displayQ = isSystem ? ev.args.question.replace(SYSTEM_PROMPT, '') : ev.args.question;
                
                feed.innerHTML += `<div class="tx-item"><strong>Anon:</strong> ${displayQ.substring(0,30)}...</div>`;
                
                const b = getByteLength(ev.args.question);
                const fee = ((Math.floor(b / 10) + 1) * 0.001).toFixed(3);
                revenue.innerHTML += `<div class="tx-item">Fee Received: +${fee} LCAI</div>`;
            });
        }

        document.getElementById('oracleQuestion').oninput = updateFeeDisplay;

        document.getElementById('shakeBtn').onclick = async () => {
            const q = document.getElementById('oracleQuestion').value;
            if (!q) return;
            const fullPrompt = SYSTEM_PROMPT + q;
            try {
                const feesOn = await ballContract.feesEnabled();
                let val = 0n;
                if (feesOn) {
                    const bytes = getByteLength(fullPrompt);
                    const cost = ((Math.floor(bytes / 10) + 1) * 0.001).toFixed(3);
                    val = ethers.parseEther(cost);
                }
                document.getElementById('resultText').innerText = "Consulting AIVM...";
                const tx = await ballContract.getPrediction(fullPrompt, { value: val, gasLimit: 2000000 });
                await tx.wait();
                hardSync();
            } catch (e) { 
                document.getElementById('resultText').innerText = "Error: Check verification or LCAI balance.";
            }
        };

        // Standard Button Handlers
        document.getElementById('lookupBtn').onclick = async () => {
            const addr = document.getElementById('lookupAddr').value;
            const res = await identityContract.getIdentity(addr);
            document.getElementById('lookupResults').innerHTML = `User: ${res[0]}<br>Verified: ${res[2] ? '✅' : '❌'}`;
        };

        document.getElementById('verifyBtn').onclick = async () => {
            const tx = await identityContract.verifyIdentity(document.getElementById('verifyAddr').value);
            await tx.wait(); hardSync();
        };

        document.getElementById('toggleFeesBtn').onclick = async () => {
            const current = await ballContract.feesEnabled();
            const tx = await ballContract.toggleFees(!current);
            await tx.wait(); hardSync();
        };

        document.getElementById('withdrawBtn').onclick = async () => {
            const tx = await ballContract.withdraw();
            await tx.wait(); hardSync();
        };

        async function connectWallet(auto = false) {
            if (!window.ethereum) return;
            const provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await window.ethereum.request({ method: auto ? 'eth_accounts' : 'eth_requestAccounts' });
            if (accounts.length === 0) return;
            signer = await provider.getSigner();
            ballContract = new ethers.Contract(BALL_CONTRACT_ADDR, BALL_ABI, signer);
            identityContract = new ethers.Contract(IDENTITY_CONTRACT, IDENTITY_ABI, signer);
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = 'block';
            hardSync();
            ballContract.on("OracleAnswer", (user, question, answer) => {
                if (user.toLowerCase() === accounts[0].toLowerCase()) {
                    document.getElementById('resultText').innerText = answer;
                }
            });
        }

        document.getElementById('connectBtn').onclick = () => connectWallet(false);
        document.getElementById('disconnectBtn').onclick = () => { localStorage.clear(); location.reload(); };
        window.onload = () => connectWallet(true);
    </script>
</body>
</html>
