<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIVM Control Center | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #5865f2; --secondary: #00ff80; --danger: #ff4444; --bg: #0f1016; --card: #1a1b26; --sidebar: #13141f; --border: #2d2f45; --text: #ffffff; --text-dim: #94a3b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: var(--sidebar); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-left-group { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .nav-identity-group { display: flex; align-items: center; gap: 10px; margin-left: 10px; padding-left: 15px; border-left: 1px solid var(--border); }
        .nav-sbt-svg { width: 28px; height: 28px; opacity: 0.2; transition: 0.3s; }
        .nav-sbt-svg.active { opacity: 1; filter: drop-shadow(0 0 5px var(--primary)); }
        .nav-desc { font-size: 0.75rem; color: var(--text-dim); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .btn-nav-connect { background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .load-indicator { background: #000; padding: 5px 12px; border-radius: 6px; color: var(--secondary); border: 1px solid #1e293b; font-size: 0.75rem; }
        .wallet-pill { background: #1e293b; padding: 5px 12px; border-radius: 6px; font-family: monospace; border: 1px solid var(--border); font-size: 0.75rem; display: flex; gap: 10px; }
        .balance-txt { color: var(--secondary); font-weight: bold; border-right: 1px solid var(--border); padding-right: 10px; }
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
        .card-title { font-size: 0.7rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; }
        .console { height: 250px; background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem; color: #7dd3fc; overflow-y: auto; }
        .admin-input { width: 100%; background: #0f111a; border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: white; margin-bottom: 10px; font-size: 0.75rem; }
        .admin-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-admin { border: none; padding: 6px 8px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.7rem; }
        .btn-query { grid-column: span 2; background: var(--border); color: white; }
        .btn-verify { background: var(--secondary); color: black; }
        .btn-revoke { background: var(--danger); color: white; }
        .btn-withdraw { width: 100%; background: #f59e0b; color: black; border: none; padding: 8px; border-radius: 6px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 0.75rem; }
        .input-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; padding: 8px; gap: 10px; }
        .prompt-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; font-size: 1rem; }
        .btn-gen { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .output-view { min-height: 400px; background: #08090f; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-dim); overflow: hidden; position: relative; }
        
        /* MINTING OVERLAY */
        .mint-overlay { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--secondary); font-size: 0.65rem; color: var(--secondary); display: none; align-items: center; gap: 8px; z-index: 10; }
        .mint-spinner { width: 10px; height: 10px; border: 2px solid var(--secondary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
        .gallery-item { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: 0.2s; position: relative; min-height: 150px; }
        .gallery-item:hover { border-color: var(--primary); }
        .gallery-img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; cursor: pointer; }
        .gallery-controls { padding: 8px; display: flex; gap: 5px; background: rgba(0, 0, 0, 0.5); }
        .btn-gallery { flex: 1; border: none; padding: 4px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; cursor: pointer; }
        .btn-view { background: var(--primary); color: white; }
        .btn-dl { background: var(--secondary); color: black; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <header>
        <div class="header-left-group">
            <div class="header-title">AIVM Control Center</div>
            <button class="btn-nav-connect" id="connect-btn">Connect Wallet</button>
            <div class="nav-identity-group">
                <div id="sbt-svg-container" class="nav-sbt-svg"></div>
                <span id="nav-id-desc" class="nav-desc">Identity Offline</span>
            </div>
        </div>
        <div class="header-right">
            <div class="load-indicator">‚óè SDXL-Turbo | Load: 21%</div>
            <div class="wallet-pill">
                <span id="balance-display" class="balance-txt">0.00 LCAI</span>
                <span id="address-display">0x00...00</span>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="sidebar">
            <div class="card"><div class="card-title">System Status Window</div><div id="console-output" class="console"></div></div>
            <div class="card">
                <div class="card-title">Admin Management</div>
                <input type="text" id="admin-user-addr" class="admin-input" placeholder="Query Address 0x...">
                <div class="admin-actions">
                    <button class="btn-admin btn-query" id="admin-query">Query Status</button>
                    <button class="btn-admin btn-verify" id="admin-verify">Verify</button>
                    <button class="btn-admin btn-revoke" id="admin-revoke">Revoke</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Owner Vault</div>
                <div style="font-size: 0.65rem; color: var(--text-dim);">Revenue Collected:</div>
                <div id="revenue-display" style="font-size: 1.2rem; font-weight: 800; color: var(--secondary); margin: 2px 0;">0.00 LCAI</div>
                <button id="withdraw-btn" class="btn-withdraw">Withdraw Funds</button>
            </div>
        </div>
        <div class="main-content">
            <div class="input-group">
                <input type="text" id="prompt-input" class="prompt-input" placeholder="Describe the art you wish to generate...">
                <button id="generate-btn" class="btn-gen">Generate (0.25 LCAI)</button>
            </div>
            <div class="output-view" id="art-output">
                <div id="mint-status" class="mint-overlay"><div class="mint-spinner"></div>Status: Minting...</div>
                Awaiting AIVM Inference Signal...
            </div>
            <div class="card">
                <div class="card-title">Previous Art History</div>
                <div id="art-gallery" class="gallery-grid"></div>
            </div>
        </div>
    </div>
    <script>
        const CONFIG = { SBT_ADDR: "0xd71462F0002Ee9373fCe05B568583Ed13e75f600", AIVM_ADDR: "0x5B2d46cb1e3451aA3d584f28E714892373D7c7C6" };
        const ABI = ["function hasSBT(address user) view returns (bool)", "function isAdmin(address user) view returns (bool)", "function owner() view returns (address)", "function setVerification(address user, bool status) external", "function generateArt(string calldata prompt) external payable", "function withdraw() external", "event ArtGenerated(address indexed user, string prompt, uint256 fee)" ];
        let provider, signer, userAddr, sbtContract, studioContract;
        const sbtSvg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="none" stroke="#5865f2" stroke-width="5"/><path d="M30 50L45 65L70 35" stroke="#00ff80" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        function log(msg, isError = false) { const out = document.getElementById('console-output'); const div = document.createElement('div'); div.style.color = isError ? "#ff4444" : "#7dd3fc"; div.innerText = `> ${msg}`; out.appendChild(div); out.scrollTop = out.scrollHeight; }
        
        async function updateVault() { if (!provider) return; const bal = await provider.getBalance(CONFIG.AIVM_ADDR); document.getElementById('revenue-display').innerText = `${parseFloat(ethers.formatEther(bal)).toFixed(2)} LCAI`; }
        
        async function connect() {
            if (!window.ethereum) return log("MetaMask not found", true);
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddr = accounts[0]; signer = await provider.getSigner();
                sbtContract = new ethers.Contract(CONFIG.SBT_ADDR, ABI, signer);
                studioContract = new ethers.Contract(CONFIG.AIVM_ADDR, ABI, signer);
                document.getElementById('address-display').innerText = `${userAddr.slice(0,6)}...${userAddr.slice(-4)}`;
                const bal = await provider.getBalance(userAddr);
                document.getElementById('balance-display').innerText = `${parseFloat(ethers.formatEther(bal)).toFixed(2)} LCAI`;
                document.getElementById('connect-btn').innerText = "Sync Active";

                studioContract.on("ArtGenerated", (user, prompt) => {
                    log(`Live Event: New AIVM Generation Detected!`);
                    document.getElementById('mint-status').style.display = 'none';
                    updateVault();
                    renderArt(prompt); 
                });

                log(`Authenticated: ${userAddr}`); checkIdentity(); updateVault(); scanHistory(); 
            } catch (err) { log("Connection failed.", true); }
        }

        async function scanHistory() {
            try {
                log("Scanning blockchain for art history...");
                const filter = studioContract.filters.ArtGenerated();
                const events = await studioContract.queryFilter(filter, -10000);
                const last10 = events.slice(-10).reverse();
                const gallery = document.getElementById('art-gallery');
                gallery.innerHTML = ''; 
                if (last10.length === 0) log("No previous art found.");
                last10.forEach(event => { addToGallery(event.args[1]); });
            } catch (e) { log("History scan failed.", true); }
        }

        function addToGallery(prompt) {
            const gallery = document.getElementById('art-gallery');
            const item = document.createElement('div');
            item.className = 'gallery-item';
            const seed = Math.floor(Math.random() * 1000000);
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=512&height=512&nologo=true&seed=${seed}`;
            
            item.innerHTML = `
                <div class="sync-text" style="height:150px; display:flex; align-items:center; justify-content:center; background:#000; font-size:0.6rem; color:var(--primary); animation:pulse 1s infinite">Syncing...</div>
                <img src="${url}" class="gallery-img" style="display:none" onload="this.style.display='block'; this.previousElementSibling.style.display='none'; this.nextElementSibling.style.display='flex'">
                <div class="gallery-controls" style="display:none"><button class="btn-gallery btn-view" onclick="swapToMain('${url}')">View</button><button class="btn-gallery btn-dl" onclick="downloadImg('${url}')">DL</button></div>`;
            gallery.appendChild(item);
        }

        async function checkIdentity() {
            try {
                const hasPass = await sbtContract.hasSBT(userAddr);
                const isAdmin = await sbtContract.isAdmin(userAddr);
                const owner = await studioContract.owner();
                const container = document.getElementById('sbt-svg-container');
                const desc = document.getElementById('nav-id-desc');
                if (hasPass || isAdmin || userAddr.toLowerCase() === owner.toLowerCase()) {
                    container.innerHTML = sbtSvg; container.classList.add('active');
                    desc.innerText = (userAddr.toLowerCase() === owner.toLowerCase()) ? "Contract Owner Verified" : "Master Admin Verified";
                    log("Access roles synchronized.");
                } else { desc.innerText = "No Pass Detected"; }
            } catch (e) { log("Identity Check Failed.", true); }
        }

        let retryCount = {};
        function renderArt(prompt) {
            const seed = Math.floor(Math.random() * 1000000);
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=1024&nologo=true&seed=${seed}`;
            const img = new Image();
            img.src = url;
            if (!retryCount[prompt]) retryCount[prompt] = 0;

            img.onload = () => {
                document.getElementById('art-output').innerHTML = `<div id="mint-status" class="mint-overlay"><div class="mint-spinner"></div>Status: Minting...</div><img src="${url}" style="width:100%; height:100%; object-fit:contain;" id="main-art-img">`;
                addToGallery(prompt);
                log(`AIVM Visualization Success.`);
                delete retryCount[prompt];
            };

            img.onerror = () => {
                if (retryCount[prompt] < 10) {
                    retryCount[prompt]++;
                    setTimeout(() => renderArt(prompt), 3000);
                }
            };
        }

        window.swapToMain = (url) => { document.getElementById('art-output').innerHTML = `<div id="mint-status" class="mint-overlay"><div class="mint-spinner"></div>Status: Minting...</div><img src="${url}" style="width:100%; height:100%; object-fit:contain;" id="main-art-img">`; };
        window.downloadImg = async (url) => { const response = await fetch(url); const blob = await response.blob(); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `AIVM_${Date.now()}.jpg`; link.click(); };

        document.getElementById('generate-btn').onclick = async () => {
            const prompt = document.getElementById('prompt-input').value;
            if (!prompt) return log("Prompt required", true);
            try {
                log("Starting AIVM Inference...");
                document.getElementById('mint-status').style.display = 'flex';
                document.getElementById('art-output').childNodes[2].nodeValue = "Inference Processing...";
                const tx = await studioContract.generateArt(prompt, { value: ethers.parseEther("0.25") });
                await tx.wait(); log("Generation Success!");
            } catch (e) { log("Generation failed.", true); document.getElementById('mint-status').style.display = 'none'; }
        };

        document.getElementById('connect-btn').onclick = connect;
        log("System Online. Awaiting Handshake...");
    </script>
</body>
</html>
